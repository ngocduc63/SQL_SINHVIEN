create database SINHVIEN

create table KHOA(
	MAKHOA CHAR(10) PRIMARY KEY,
	TENKHOA VARCHAR(30)
)
CREATE TABLE LOP(
	MALOP CHAR(10) PRIMARY KEY,
	TENLOP VARCHAR(20),
	SISODK INT,
	MAKHOA CHAR(10),
	FOREIGN KEY (MAKHOA) REFERENCES KHOA (MAKHOA)
)

CREATE TABLE SINHVIEN(
	MASV CHAR(10) PRIMARY KEY,
	HOTEN VARCHAR(20),
	NGSINH DATE,
	DCHI VARCHAR(30),
	GIOITINH VARCHAR(10),
	MALOP CHAR(10),
	FOREIGN KEY (MALOP) REFERENCES LOP (MALOP)
)

CREATE TABLE MONHOC(
	MAMH CHAR(10) PRIMARY KEY,
	TENMH VARCHAR(20),
	SOTIET INT
)
CREATE TABLE KETQUA(
	MASV CHAR(10) NOT NULL,
	MAMH CHAR(10) NOT NULL,
	DIEM FLOAT,
	PRIMARY KEY (MASV, MAMH),
	FOREIGN KEY (MASV) REFERENCES SINHVIEN (MASV),
	FOREIGN KEY (MAMH) REFERENCES MONHOC (MAMH)
)
-- 1. Cho biết tên những môn học có số tiết >=30 và <=90
SELECT TENMH
FROM MONHOC
WHERE SOTIET BETWEEN 30 AND 90

-- 2.Cho biết họ tên những sinh viên học lớp ‘D15CNPM4’ có điểm thi trong khoảng từ 6 đến 8 điểm
SELECT HOTEN
FROM SINHVIEN, LOP, KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV AND SINHVIEN.MALOP = LOP.MALOP
AND TENLOP = 'D15CNPM4' AND DIEM BETWEEN 6 AND 8

-- 3. Cho biết tên những môn học có số tiết <60 và do những sinh viên thuộc khoa ‘CNTT ’ theo học.
SELECT TENMH
FROM MONHOC, KHOA, SINHVIEN, LOP, KETQUA
WHERE MONHOC.MAMH = KETQUA.MAMH AND KHOA.MAKHOA = LOP.MAKHOA AND SINHVIEN.MASV = KETQUA.MASV
AND SINHVIEN.MALOP = LOP.MALOP
AND SOTIET < 60 AND TENKHOA = 'CNTT'
-- 4.Cho biết tên những sinh viên thuộc khoa ‘CNTT’ học môn học có tên là ‘HQTCSDL’ với số điểm <5
SELECT HOTEN
FROM MONHOC, KHOA, SINHVIEN, LOP, KETQUA
WHERE MONHOC.MAMH = KETQUA.MAMH AND KHOA.MAKHOA = LOP.MAKHOA AND SINHVIEN.MASV = KETQUA.MASV
AND SINHVIEN.MALOP = LOP.MALOP
AND TENKHOA = 'CNTT' AND TENMH = 'HQTCSDL' AND DIEM < 5
-- 5. Liệt kê danh sách tên khoa và số lượng lớp trong từng khoa.

SELECT TENKHOA 
FROM LOP,KHOA
WHERE LOP.MAKHOA = KHOA.MAKHOA
GROUP BY TENKHOA
-- 6. Cho biết họ tên những sinh viên nào học trên 5 môn học.
SELECT SINHVIEN.MASV,HOTEN
FROM SINHVIEN, KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV
GROUP BY SINHVIEN.MASV,HOTEN
HAVING COUNT(KETQUA.MASV) >= 5
-- 7. Cho biết tên những khoa có ít nhất 3 lớp.
SELECT TENKHOA 
FROM LOP,KHOA
WHERE LOP.MAKHOA = KHOA.MAKHOA
GROUP BY TENKHOA
HAVING COUNT (TENLOP) >= 3
--8.Cho biết tên những lớp có sĩ số thực ít nhất 30 học sinh.
SELECT TENLOP
FROM LOP, SINHVIEN
WHERE LOP.MALOP = SINHVIEN.MALOP
GROUP BY TENLOP
HAVING COUNT (MASV) >= 30
-- 9. Cho biết tên những khoa có nhiều nhất 100 học sinh.
SELECT TENKHOA
FROM KHOA, LOP
WHERE KHOA.MAKHOA = LOP.MAKHOA
GROUP BY TENKHOA
HAVING SUM(SISODK) <= 100
-- 10. Cho biết tên những môn học có số tiết >30 và có ít nhất 20 sinh viên theo học.
SELECT TENMH
FROM MONHOC, KETQUA
WHERE MONHOC.MAMH = KETQUA.MAMH AND SOTIET > 30
GROUP BY TENMH
HAVING COUNT (MASV) >= 20
--11. Cho biết tên những môn học có số tiết lớn nhất.
SELECT TENMH
FROM MONHOC
WHERE SOTIET = (
	SELECT MAX(SOTIET)
	FROM MONHOC
)
--12. Cho biết tên những sinh viên học nhiều môn học nhất.
SELECT HOTEN
FROM SINHVIEN, KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV
GROUP BY HOTEN
HAVING COUNT(KETQUA.MASV) >= ALL (
	SELECT COUNT(KETQUA.MASV) 
	FROM SINHVIEN, KETQUA
	WHERE SINHVIEN.MASV = KETQUA.MASV
	GROUP BY HOTEN
)

--13. Cho biết tên những môn học có nhiều sinh viên theo học nhất.
SELECT TENMH
FROM MONHOC, KETQUA
WHERE MONHOC.MAMH = KETQUA.MAMH
GROUP BY TENMH
HAVING COUNT (*) >= ALL (
	SELECT COUNT (*) 
	FROM MONHOC, KETQUA
	WHERE MONHOC.MAMH = KETQUA.MAMH
	GROUP BY TENMH
)

--14. Cho biết tên những lớp thuộc khoa ‘CNTT’ có số lượng sinh viên ít nhất.
SELECT TENLOP
FROM LOP, KHOA, SINHVIEN
WHERE LOP.MAKHOA = KHOA.MAKHOA AND SINHVIEN.MALOP = LOP.MALOP AND TENKHOA =  'CNTT'
GROUP BY TENLOP
HAVING COUNT (*) >= ALL(
	SELECT COUNT (*)
	FROM LOP, KHOA, SINHVIEN
	WHERE LOP.MAKHOA = KHOA.MAKHOA AND SINHVIEN.MALOP = LOP.MALOP AND TENKHOA =  'CNTT'
	GROUP BY TENLOP
)

--15. Liệt kê mã sinh viên, họ tên của những sinh viên nữ có điểm trung bình cao nhất.
SELECT SINHVIEN.MASV, HOTEN
FROM SINHVIEN , KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV AND GIOITINH = 'Nu' 
GROUP BY SINHVIEN.MASV, HOTEN
HAVING AVG(DIEM) >= ALL (
	SELECT AVG(DIEM) 
	FROM SINHVIEN , KETQUA
	WHERE SINHVIEN.MASV = KETQUA.MASV AND GIOITINH = 'Nu' 
	GROUP BY SINHVIEN.MASV, HOTEN
)
--16. Liệt kê danh sách tên những môn học mà chưa có sinh viên nào theo học.
SELECT DISTINCT TENMH
FROM MONHOC, KETQUA
WHERE MONHOC.MAMH NOT IN (
	SELECT MAMH
	FROM KETQUA
)
-- 17. Liệt kê tên những sinh viên chưa học môn có tên là ‘CO SO DU LIEU’.
SELECT HOTEN
FROM SINHVIEN
WHERE MASV NOT IN(
	SELECT SINHVIEN.MASV
	FROM SINHVIEN, KETQUA, MONHOC
	WHERE SINHVIEN.MASV = KETQUA.MASV AND MONHOC.MAMH = KETQUA.MAMH AND TENMH = 'CO SO DU LIEU'
)
--18. Liệt kê tên những sinh viên chỉ học môn ‘CO SO DU LIEU’.
SELECT HOTEN
FROM SINHVIEN, MONHOC, KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV AND MONHOC.MAMH = KETQUA.MAMH AND TENMH = 'CO SO DU LIEU'
AND KETQUA.MASV IN (
	SELECT KETQUA.MASV
	FROM KETQUA, SINHVIEN, MONHOC
	WHERE KETQUA.MASV = SINHVIEN.MASV AND MONHOC.MAMH = KETQUA.MAMH
	GROUP BY KETQUA.MASV
	HAVING COUNT (*) = 1 
)
--19. Liệt kê tên những sinh viên nam thuộc khoa ‘CNTT’ hoặc khoa ‘QLNL’ đã học trên 5 môn học.
SELECT DISTINCT HOTEN
FROM SINHVIEN, KETQUA, LOP, KHOA
WHERE SINHVIEN.MASV = KETQUA.MASV AND LOP.MAKHOA = KHOA.MAKHOA AND GIOITINH = 'Nam'
AND (TENKHOA = 'CNTT' OR TENKHOA = 'QLNL')
AND SINHVIEN.MASV IN (
	SELECT KETQUA.MASV
	FROM KETQUA, SINHVIEN, MONHOC
	WHERE KETQUA.MASV = SINHVIEN.MASV AND MONHOC.MAMH = KETQUA.MAMH
	GROUP BY KETQUA.MASV
	HAVING COUNT (*) >= 5
)
--20. Liệt kê tên những lớp có sĩ số thực sự vượt sĩ số dự kiến.

WITH RES AS(	
	SELECT L.MALOP,  COUNT (SV.MALOP) AS 'SISOTHUC'
	FROM SINHVIEN SV RIGHT JOIN LOP L
	ON SV.MALOP = L.MALOP
	GROUP BY L.MALOP
)
SELECT TENLOP
FROM RES, LOP
WHERE RES.MALOP = LOP.MALOP AND RES.SISOTHUC > LOP.SISODK



--------------------------------------------------------------------------------

SELECT SINHVIEN.MASV, HOTEN
FROM SINHVIEN, KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV
GROUP BY SINHVIEN.MASV,SINHVIEN.HOTEN 
HAVING COUNT(KETQUA.MASV) >= 5

SELECT TENKHOA
FROM KHOA,LOP
WHERE KHOA.MAKHOA = LOP.MAKHOA
GROUP BY KHOA.TENKHOA
HAVING COUNT(*) >= 3

SELECT TENLOP, SINHVIEN.MALOP
FROM LOP, SINHVIEN
WHERE LOP.MALOP = SINHVIEN.MALOP
GROUP BY SINHVIEN.MALOP, TENLOP
HAVING COUNT (*) >= 30



SELECT TENKHOA
FROM KHOA, LOP
WHERE KHOA.MAKHOA=LOP.MAKHOA
GROUP BY TENKHOA
HAVING SUM(SISODK)=100

SELECT TENMH
FROM MONHOC,KETQUA
WHERE MONHOC.MAMH = KETQUA.MAMH AND SOTIET >30
GROUP BY TENMH
HAVING COUNT (MASV) >=20 

SELECT TENMH
FROM MONHOC
WHERE SOTIET >= ALL (SELECT SOTIET FROM MONHOC)

SELECT SINHVIEN.MASV,HOTEN 
FROM SINHVIEN , KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV
GROUP BY SINHVIEN.MASV, HOTEN 
HAVING COUNT(*) >= ALL ( SELECT COUNT(*) FROM KETQUA GROUP BY MASV)

SELECT MONHOC.TENMH
FROM MONHOC,KETQUA
WHERE MONHOC.MAMH=KETQUA.MAMH
GROUP BY MONHOC.TENMH
HAVING COUNT(kETQUA.MASV)>=ALL(SELECT COUNT(MASV) from ketqua group by MAMH)





SELECT TENLOP
FROM LOP,KHOA,SINHVIEN
WHERE TENKHOA='CNTT'
AND KHOA.MAKHOA=LOP.MAKHOA AND SINHVIEN.MALOP=LOP.MALOP
GROUP BY TENLOP
HAVING COUNT(SINHVIEN.MASV)<=ALL(SELECT COUNT (MASV) FROM LOP,KHOA,SINHVIEN
WHERE TENKHOA='CNTT'
AND KHOA.MAKHOA=LOP.MAKHOA AND SINHVIEN.MALOP=LOP.MALOP
GROUP BY TENLOP)









SELECT SINHVIEN.MASV, HOTEN
FROM SINHVIEN , KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV AND SINHVIEN.GIOITINH='NU'
GROUP BY SINHVIEN.MASV, HOTEN
HAVING AVG(DIEM)>=ALL(SELECT AVG(DIEM)FROM SINHVIEN , KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV AND SINHVIEN.GIOITINH='NU'
GROUP BY SINHVIEN.MASV, HOTEN)




--16
  SELECT DISTINCT TENMH 
  FROM MONHOC 
  WHERE MAMH
  NOT IN (
  SELECT MAMH
  FROM KETQUA
  )
  --17. TEN NHUNG HOC SINH CHUA HOC MON CO SO DU LIEU
  SELECT HOTEN
  FROM SINHVIEN
  WHERE MASV NOT IN(SELECT MASV 
                    FROM KETQUA, MONHOC 
                    WHERE KETQUA.MAMH=MONHOC.MAMH
					AND TENMH='CO SO DU LIEU')

--18.LIET KE NHUNG SINH VIEN CHI HOC MON CHI HOC MON 'CO SO DU LIEU'
SELECT SINHVIEN.*
FROM SINHVIEN,MONHOC,KETQUA
WHERE SINHVIEN.MASV=KETQUA.MASV AND MONHOC.MAMH = KETQUA.MAMH AND TENMH = 'CO SO DU LIEU'
and KETQUA.MASV IN (
SELECT KETQUA.MASV
FROM KETQUA,SINHVIEN,MONHOC
WHERE SINHVIEN.MASV=KETQUA.MASV AND MONHOC.MAMH = KETQUA.MAMH
GROUP BY KETQUA.MASV
HAVING COUNT (*)=1
)
SELECT SINHVIEN.*
FROM SINHVIEN,MONHOC,KETQUA
WHERE SINHVIEN.MASV=KETQUA.MASV AND MONHOC.MAMH = KETQUA.MAMH AND TENMH = 'CO SO DU LIEU'
and KETQUA.MASV NOT IN (
SELECT KETQUA.MASV
FROM KETQUA,SINHVIEN,MONHOC
WHERE SINHVIEN.MASV=KETQUA.MASV AND MONHOC.MAMH = KETQUA.MAMH AND TENMH <>'CO SO DU LIEU'
)
--19)LIET KE TEN NHUNG SINH VIEN NAM THUOC KHOA CNTT OR HOAC QLNL DA HOC TREN 5 MON HOC 
SELECT KETQUA.MASV, HOTEN
FROM SINHVIEN, KETQUA, LOP, KHOA
WHERE SINHVIEN.MASV= KETQUA.MASV AND LOP.MAKHOA = KHOA.MAKHOA AND GIOITINH = 'Nam' 
AND (TENKHOA ='CNTT' OR TENKHOA ='QLNL')
GROUP BY KETQUA.MASV, HOTEN
HAVING COUNT (DISTINCT MAMH) > 5
--20) LIET KE TEN LOP CÓ SI SO THUC SU VUOT SI SO DU KIEN 
WITH RES AS(	
	SELECT SINHVIEN.MALOP,  COUNT (*) AS 'SISOTHUC'
	FROM LOP,SINHVIEN WHERE SINHVIEN.MALOP=LOP.MALOP
	GROUP BY SINHVIEN.MALOP
)
SELECT TENLOP
FROM RES, LOP
WHERE RES.MALOP = LOP.MALOP AND RES.SISOTHUC > LOP.SISODK

SELECT TENKHOA
FROM KHOA

create table SV_LOP(
	MASV CHAR(10) PRIMARY KEY,
	HOTEN VARCHAR(20)
)
insert into SV_LOP
SELECT MASV, HOTEN
FROM SINHVIEN, LOP
WHERE SINHVIEN.MALOP = LOP.MALOP
AND TENLOP = 'D15CNPM4'

DELETE FROM SV_LOP

insert into SV_LOP
SELECT SINHVIEN.MASV, HOTEN
FROM SINHVIEN, LOP, KETQUA
WHERE SINHVIEN.MALOP = LOP.MALOP AND SINHVIEN.MASV = KETQUA.MASV 
AND GIOITINH = 'Nam' AND TENLOP = 'D15CNPM4'
GROUP BY SINHVIEN.MASV, HOTEN
HAVING AVG(DIEM) > 7

INSERT INTO SV_LOP
SELECT SINHVIEN.MASV , HOTEN
FROM SINHVIEN, KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV
AND KETQUA.MASV IN (
	SELECT MASV
	FROM KETQUA
	WHERE DIEM < 4
	GROUP BY MASV
	HAVING COUNT(MAMH)  = 3
)
GROUP BY SINHVIEN.MASV, HOTEN
HAVING AVG(DIEM) < 5.5 

INSERT INTO SV_LOP
SELECT SINHVIEN.MASV , HOTEN
FROM SINHVIEN, KETQUA
WHERE SINHVIEN.MASV = KETQUA.MASV and ketqua.DIEM <4
GROUP BY SINHVIEN.MASV, HOTEN
HAVING AVG(DIEM) < 5.5 and COUNT(KETQUA.MAMH)=3

-- --------------------------------------------------------------------------

--Khai báo biến DTB gán giá trị diểm tb mon co so du lieu cua D15CNPM4

DECLARE @DTB FLOAT
SET @DTB =( SELECT AVG(DIEM)
			FROM KETQUA, SINHVIEN, LOP, MONHOC
			WHERE KETQUA.MASV = SINHVIEN.MASV AND LOP.MALOP = SINHVIEN.MALOP
			AND MONHOC.MAMH = KETQUA.MAMH AND TENMH = 'CO SO DU LIEU' AND TENLOP ='D15CNPM4' 
			)
PRINT @DTB
-- KHAI BÁO BIẾN SOMONHL DE LƯU TRỮ SỐ MÔN HỌC CÓ ĐIỂM < 4 CỦA SINH VIEN 'NGUYEN NGOC DUC'
--LỚP D15CNPM4
DECLARE @SOMONHL INT
SET @SOMONHL = (SELECT COUNT(*)
				FROM KETQUA, SINHVIEN, LOP, MONHOC
				WHERE KETQUA.MASV = SINHVIEN.MASV AND LOP.MALOP = SINHVIEN.MALOP
				AND MONHOC.MAMH = KETQUA.MAMH AND HOTEN = 'Nguyen Ngoc Duc'
				AND TENLOP ='D15CNPM4' AND DIEM < 4
				)
PRINT @SOMONHL
--------------------------------------------------------------------------------
 --tạo liên kết mặc định
CREATE DEFAULT DEF_SSDK AS 50
-- liên kết giá trị mặc định vào bảng
EXEC SP_BINDEFAULT DEF_SSDK, 'LOP.SISODK'
-- hủy liên kết mặc định
EXEC SP_UNBINDEFAULT 'LOP.SISODK'
-- Xóa giá trị mặc định
DROP DEFAULT DEF_SSDK

CREATE DEFAULT DEF_MALOP AS 'LOP01'

EXEC SP_BINDEFAULT DEF_MALOP, 'SINHVIEN.MALOP'
--EXEC SP_UNBINDEFAULT 'SINHVIEN.MALOP'
--DROP DEFAULT DEF_MALOP

-----------------------------------------------------------------------------------------
--TẠO RULE 

CREATE RULE DIEMSO AS @DIEMSO BETWEEN 0 AND 10

EXEC SP_BINDRULE DIEMSO, 'KETQUA.DIEM'

EXEC SP_UNBINDRULE 'KETQUA.DIEM'
DROP RULE DIEMSO

CREATE RULE GIOITINH AS @GIOITINH IN ('NAM','NU')

EXEC SP_BINDRULE GIOITINH, 'SINHVIEN.GIOITINH'



IF EXISTS (SELECT * FROM KETQUA WHERE DIEM > 5)
BEGIN 
	PRINT 'DANH SACH: '
	SELECT *
	FROM SINHVIEN, KETQUA
	WHERE KETQUA.MASV = SINHVIEN.MASV AND DIEM > 5
END
ELSE 
	PRINT 'KHONG CO' 

-- DUA RA DANH SACH SINH VIEN DAT LOAI GIOI

IF EXISTS (	SELECT KETQUA.MASV, SINHVIEN.HOTEN
			FROM SINHVIEN, KETQUA, MONHOC
			WHERE KETQUA.MASV = SINHVIEN.MASV AND KETQUA.MAMH = MONHOC.MAMH
			GROUP BY KETQUA.MASV, SINHVIEN.HOTEN
			HAVING (SUM(DIEM * (SOTIET / 15 ))) / (SUM( SOTIET / 15 )) >= 8
			)
BEGIN 
	PRINT 'DANH SACH SINH VIEN DAT LOAI GIOI: '
	SELECT KETQUA.MASV, SINHVIEN.HOTEN
	FROM SINHVIEN, KETQUA, MONHOC
	WHERE KETQUA.MASV = SINHVIEN.MASV AND KETQUA.MAMH = MONHOC.MAMH
	GROUP BY KETQUA.MASV, SINHVIEN.HOTEN
	HAVING (SUM(DIEM * (SOTIET / 15 ))) / (SUM( SOTIET / 15 )) >= 8
END
ELSE 
	PRINT'KHONG CO SINH VIEN DAT LOAI GIOI' 
